{% extends "mem_app/base.html" %}
{% block title %} Bible Memorization {% endblock %}
{% block body %}
<h1>Welcome {{ user }}</h1>
<a href="{% url 'logout_view' %}">Logout</a>
<h2>Search the Bible (ESV)</h2>
<form action="{% url 'search' firstPage %}" method="GET">
    <input autofocus autocomplete="off" type="text" name="search_q" placeholder="Keyword or Phrase"/>
    <button>Search</button>
</form><br/>

{% if message %}
    <span> {{ message }}</span>
{% endif %}
<div>
    {% if currentPage and not message %}
        {% if currentPage > 1 %}
            <a href="http://127.0.0.1:8000/search/{{ previousPage }}?search_q={{ search_q }}">Previous</a>
        {% endif %}
        <span>Page {{ currentPage }} of {{ totalPages }}</span>
        {% if nextPage <= totalPages and totalPages > 1 %}
            <a href="http://127.0.0.1:8000/search/{{ nextPage }}?search_q={{ search_q }}">Next</a>
        {% endif %}
    {% endif %}
    {% for passage in passages %}
        <div class="passage">
            <h3>{{ passage.reference }}</h3>
            <span>{{ passage.content }}</span>
            <button class="btnAddVerse">Memorize</button>
        </div>
        <br/>
    {% endfor %}
    {% if currentPage and not message %}
        {% if currentPage > 1 %}
            <a href="http://127.0.0.1:8000/search/{{ previousPage }}?search_q={{ search_q }}">Previous</a>
        {% endif %}
        <span>Page {{ currentPage }} of {{ totalPages }}</span>
        {% if nextPage <= totalPages and totalPages > 1 %}
            <a href="http://127.0.0.1:8000/search/{{ nextPage }}?search_q={{ search_q }}">Next</a>
        {% endif %}
    {% endif %}
</div>
{% if verses %}
    <h2>Your Memory Verses</h2>
    <ul>
        {% for verse in verses %}
        <li>
            <a href="http://127.0.0.1:8000/memorize/{{ verse }}">{{ verse }}</a>
        </li>
        {% endfor %}
    </ul>
{% endif %}
<script>
    // add event listeners to all the generated buttons
    const btns = document.getElementsByClassName("btnAddVerse")
    for (let i = 0; i < btns.length; i ++){
        btns[i].addEventListener("click", addVerse);
    }

    // send JSON string with verse reference and text to server
    function addVerse(event){
        // get reference and verse text from DOM
        const verseElement = event.target.previousElementSibling;
        const text = verseElement.innerHTML;
        const ref = verseElement.previousElementSibling.innerHTML;

        // setup url and data for the POST request
        url = "http://127.0.0.1:8000/add-verse";
        const data = {
            "ref": ref,
            "text": text,
            "csrfmiddlewaretoken": Cookies.get("csrftoken")
        };
        
        // send POST request to server
        fetch(url, {
            method: "POST",
            credentials: "include",
            headers: {
                "X-CSRFToken": Cookies.get("csrftoken"),
                "Content-type": "application/json",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify(data)
        }).then(res => res.json())
        //upon successful response: redirect
        .then(response => {
            window.location.href=`http://127.0.0.1:8000/memorize/${response.ref}`;
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}